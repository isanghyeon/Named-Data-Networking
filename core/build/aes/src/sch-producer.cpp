
/* -*- Mode:C++; c-file-style:"gnu"; indent-tabs-mode:nil; -*- */
/*
 * Copyright (c) 2013-2022 Regents of the University of California.
 *
 * This file is part of ndn-cxx library (NDN C++ library with eXperimental eXtensions).
 *
 * ndn-cxx library is free software: you can redistribute it and/or modify it under the
 * terms of the GNU Lesser General Public License as published by the Free Software
 * Foundation, either version 3 of the License, or (at your option) any later version.
 *
 * ndn-cxx library is distributed in the hope that it will be useful, but WITHOUT ANY
 * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
 * PARTICULAR PURPOSE.  See the GNU Lesser General Public License for more details.
 *
 * You should have received copies of the GNU General Public License and GNU Lesser
 * General Public License along with ndn-cxx, e.g., in COPYING.md file.  If not, see
 * <http://www.gnu.org/licenses/>.
 *
 * See AUTHORS.md for complete list of ndn-cxx authors and contributors.
 */

//
// Created by 이상현 on 2022/11/07.
//

#include <ndn-cxx/face.hpp>
#include <ndn-cxx/security/key-chain.hpp>
#include <ndn-cxx/security/signing-helpers.hpp>

#include <iostream>

// Enclosing code in ndn simplifies coding (can also use `using namespace ndn`)
namespace ndn {
// Additional nested namespaces should be used to prevent/limit name conflicts
    namespace examples {

        class Producer
        {
        public:
            void
            run()
            {
                m_face.setInterestFilter(Name("/sch.ac.kr/calab/research.file", 0),
                                         std::bind(&Producer::onInterest, this, _1, _2),
                                         nullptr, // RegisterPrefixSuccessCallback is optional
                                         std::bind(&Producer::onRegisterFailed, this, _1, _2));

                auto cert = m_keyChain.getPib().getDefaultIdentity().getDefaultKey().getDefaultCertificate();
                m_certServeHandle = m_face.setInterestFilter(security::extractIdentityFromCertName(cert.getName()),
                                                             [this, cert] (auto&&...) {
                                                                 m_face.put(cert);
                                                             },
                                                             std::bind(&Producer::onRegisterFailed, this, _1, _2));
                m_face.processEvents();
            }

        private:
            void
            onInterest(const InterestFilter&, const Interest& interest)
            {
                std::cout << ">> I: " << interest << std::endl;

                static const std::string content("FFD8FFE00104A4649460110010100FFDB0430322322333343345855445A7768CACCBABBDE1210DE11EBB101610111314151515CF171816141812141514FFDB0431344545955914DBD1414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414FFC0011806412E3122021113111FFC401D010303111000000000789456123FFC40491001323463B9750000102345671181221411331365175B33261719141518224252728191B1233337557493A1C3D317256294A2D2E12653638292FFC401D110310311000000000678523491FFC4040110123394686300000102341156122131354151617191B171372C11416334281A1151722323682D1E12334A2B2B3F05292F1FFDA0C31021131103F0B06888B252E5222222222222222222222222222222287769EEC5DB3C41BE5C8AB4AB2DB4F762ED9E20DF2E455A56ACECF340B3C4EEAA9EBCDA45DC74444456628AA22222222222222222222222229D39F666D9FB3B3F55A9D39F666D9FB3B3F523B0FDB3F879A8ADE0F62CE3E4BB6444532564444444444444444444444444444445372222FCB25BB911111111111111111111111111111143BB4F762ED9E20DF2E455A5596DA7BB176CF106F9722AD2B567679A059E277554F5E6D22EE3A22222B3145511111111111111111111111114E984FB336CFD9D9F8282D4E984FB336CFD9D9F8291D87ED9FC3CD456F07B1671F25DB22229928322222222222222222222222222222229B91117E592DDC888888888888888888888888888888A1DDA7BB176CF106F9722AD2ACB6D3DD8BB678837CB915695AB3B3CD02CF13BAAA7AF3691771D11111598A2A8A66C9DD92F1FE72D34770A0A18ED1637F16DD2EA4C51C83FF01B402E7F3E206EEA8DEBDEEC49B375266BDEEA715E24A6153866D1308A2A4938B2B6A740EDD78E6C602D247538B9A388DEB48E38990C6D8E363638DA035AD68D003A80B89393FDCBBBB879D4FEC2BB427A189A9B243E60339DFB87CCF5A696F7352C347FDF78D2E35B21E56FA48E9CFFECC9AFF05FD6F7EE6AE1A9E2D2D18CAEB452FD2ADA68AA47DCDE8FF01571C9D02E3D35CE8EB257C755413C8CF4991C81C5BED0F05C6F4E99AD71F453DF576CA0DC1DC8E66BCEB559B9981EE7EE62E148E5A9B1CB438B691849CA47F4153BA6BA98E4D07D8D7B8FA956FBC596E1876E53DBEEB43536DAF8EECB4B5713A29633DCE6B80216DDB9C1AD2E71001A92792C94DA9737BFB65CDFBA5D69A4DFB3517F77DB74EA74C27F29FFBB8B9FC7880E0392ED484DC598716BC641AD4AF1D8B2566436C580E2B8D373F13B727C544688B9F6B5C714DEA8AD169A496BEE55B2B61A7A6846AE91E7A87FC9E0712BB24D3295010B886B45495C0B8806A4F50AE5E516CCB8E315E17B54B35036C54C69D87A4BA9313CF0E5185FF0780F7A9D366CD8FEC3939474B79BE455EF19B9A1EEA97B77A1A2775EEC0F31D5D21E2796E8241B12B962DE8926E77A2815392A7C87EBC94FE5AE2429F86C7DA8E229970B4D399F21CD566A1D8AE9DAD6B315C923B4E2D8288340FB4BCEBF72F95FB15CE693458AE463B4EDA8A2E4FB43C69F72B348BE6F58ED4AD7BEF937F4522F50EEE61C1E8BFD4FAF3C4A8A635D9B71AEC85F53EF165E28983574F6C7190B47AD8407FAC9081DEA2DEA5A7AA1BCE8D9DED79854F3DCED11C56CC46017748D1BB1551EE90F9DFE3EBEFD786929B32F66370853C0AFBC3CC798E4AB8BC1D9A087DD3163B8923DC7673E13E473EDD4A92AF6396595F74CD5BBD55BAD551474D3D3C1EF873AB1EF6B4B7783741BAD71D7570E4BCC5CED95566B85450D740FA5ACA7798E58641A398E07882A76D8D3B7B7AF0C3E6C6A6969CD3E5A4624C413940A8D6154F77ACF85685AF246681C2E758CC731E4B8FF137C65FAD2C5FBF9BFA4BC1668E4EDE7295D6D177AAA1A935E24317BC9EF76EEE6EEBBDBCC6FD31D5AF35A06AAEEDADF9DC1FF56AFF092A0F62DBF3B3D3DE5E31184D756C4F92B7EF5DCAB22C8B1E34ECAB5C1EDC34ABAA32B9AE4E55635CFB0D9E6C437CB75AA9DCC6545754C74B1BA524339EE0D04909D353C7457017A6CBFD25E12F17A4F398AC88CE2C84E7B73807A2A16521B634C4384FCCE707E254A7F137C65FAD2C5FBF9BFA49F137C65FAD2C5FBF9BFA4AE2A2A73D6AB4B68E4B547D5C581FF177FD8AA5E888B0DA9DA22222222222222222222222222222287769EEC5DB3C41BE5C8AB4AB2DB4F762ED9E20DF2E455A56ACECF340B3C4EEAA9EBCDA45DC74444456628AAD66D90AC70D87673C171421A4CF4AFAB91C07173A591EF3AF7E9BC7B05312AE7B0763DA6C599F436912EF5C70FCF251D446E7DEDC73DD244ED3934B5DBA3D71BBB958C5059905B19E1DB4AD17653D912423A1E6C23E428B3976F9CDBC4571CD4ABC131D6D45161DB6416F5242F2D65549246D94C8F3D2D379AD0EA6E923424AAAB4D5335154473D3CAF8278DC1CC922716B9A475147156A9ED17B29D833FDB05C1D57258F12D2C5D0C5718A3E91924692192B351BC12ED0828D798E0A9263DD8873570474B2C1678B12D14637BA7B2CBD2BB4EEE89C1B213F55A7DAA4525333BA6C3AD08556DBF64DA3E991267097B49A8232D06A14CE29C9706D9B60E6352E5CDF307D7DD5D79A6B8D29A58ABEB897D5D335C747E9275BC3985EDF95A91A828D3438AE4DCAD95966AE9A8AE1493DD642EDC969EA6331C91BBB9CD7041F6AE32E9B21B1952C14AA88C7998F3185B1DC4E1C82BA916827B9FD9170D8F0CBF31AED4CD75D2E61F0DAC48DE353025AE906BD4E91C8D7E8B46874795433DD8AA314622B5D9A8C035771AA8A9217AB7E478637F890B69FFD8E930C58ADD67B7C7D0D0DBE9A3A5A78F5D776363435A3EE01726D48C59C431AFA29A5D0906CC4CBA6A2A8879B89D7F1D42EC1799C7B98B62CB7B47C217BABE85AED44304637A59DC3931BCF9713A01A8D485DF5C6E15AADF555B552086969A274D2C87A9AC6825C7EC0ACF2CCAC7F5D9938B6B2F35AE7358F7165353976A2841F92C1F893CC9279AFE58563FD2B18E3346373EFDC177EF8DE9176E59A28E8D12B841CC0CEE3E4359E54C98836CDBC4B54458EC3454D4C090DC1CF99EE1C8E8C2CDF671F6AFB87B6CDBBC55405F6C345534E4805D6F73E27B4733A3CB83BD9A8F6AAE28ACFF057ACCC183B91CCD79D6AB3C7AEF783BDEFBD28D7651B4E54A2D18C598D62CC8B4FBFEC957D3359A9A0906ECB38F27B7973E2350743A12BCAE6F67D5972BE9DF4AC2DB9DFDCDFC9D46EE11EA383A53F3473D3ACF0E47514A7BE2FBC6BB83EBAC95F2DBEA9F13A1749111F298E1A1041E07BC77108E202EAEA2A25ABA89279E57CD3CAE2F7C9238B9CF713A9249EB27BD70215D182D9A2F7BEBB50D7C09D9C329DCA6B33DA7CDC4B3C428383660E42EF746F68DA77E41BEB93B5C618B6E58E710D5DEAEB2B25ADA92B8C6CC6B401A35A0E4003BF871254CFB1A76F6F5E187CD8D57F5603634EDEDEBC3F9B1A905B6C6C3B2A2B18283687259BA316247BC92D162B8B9CE79249CE4906A4AB7CAAEEDADF9DC1FF56AFF092AD1282B69BCACC47993261C360A36550A31526DF9991EEEFF047BBE911AFA2555377E2C38169428915C1AD15CA72FBA5691BED2D1E72C98812CC2F79C340549A3DA73DD955365E9B2C3F49784BC5E93CE62F67F15CCC4FD5107F9D87FDCBBBC0DB37E3CB2636C3F71ABB5C31D251DC29EA2678AB89C5AC648D738E81DA9E0AB6A62D4907417811DB5A1F786CE2B33C8DDCB6593709CE93880737DC76D1B95CA4445422DA2A97A222C94B94888888888888888888888888888888A1DDA7BB176CF16F9722AD2ACB6D3DD8BB678837CB915695AB3B3CD2CF13BAAA7AF36917701D11111598A2AA44C8BCEEBDE446368AFB6A2AA9646886BEDD23B763AB875D7749E3BAE1D6D769CF78241D42CA3CF7C1F9D7696D5E1CB9B1F56D66F545B2A08655D3F56BBD1EBC471D379BAB4F22B1E5722DF71AAB4D6C3594353351D5C0E0F8AA29E431C91B87516B87107D6173A6A49933F6B33B6A94D8F7823D95FC3A6286756CE056E022CB6C7B71E6AE0A6C5D45D6C4D471B434437A87A47E9DFD2B4B6427D6E7395CCD9E36BEC399EB59F2CD48FC3D8A46646D04B28923A96B78B8C32683520D4B484D48DE0911E8F231A0C44546E567D9F78E46D07884D25AF3A8EBE07379A92333F26F8E75A1D4189ECFD69C2D86B1A372A69C9E71C838B78E874F44E9C411C1662ED1BB3E5D323183286795D5F64AEE96DB71DDDDE95A8DE63C7507B751AE9C0828EBD06B7A82F6D3C0F0E34D9F71C861125659C32E94CF3F3C67F287F74E9069ECEE5E72334E8510309FB257A2F0D91067655F1DADA4468A83B69A8EDDDBACFD9CE065467CE0649E88BDD2BBED12348FE202D8358B79678922C1D98D85AFB3EA6B65D296B250DEB2C8E56B9C3EE056D1B5C1CDE41046A08E6BEAB581C6C3B971EE5BDA604666B041E63F651F6D15935E4E627920243DD4ED88E9F45F2358EFF4B8AA6B4971961E662DC2777B33DC182BA96483DC35C739A435DA7A8E87EC59C973B6D4D9AE355415913A0ABA691D0CB13BADAF69D8FBC29C5CE8AC32F1617BC0D7E0453C9569DAA4B4513B2F327EE1696FC4124F304725C54445612A391111111580D8D3B7B7AFC3E6C6ABFAB1B1A76F6F5E187CD8D76DED191B8798534B99F88253C5E455BE445AED1B9BF7DCAB92C02CADA470AE13997DF5117FA1D1E9A68E1A7A655252729127A3B65EFDE35CFB857C96B9B56D38163C9BE7A66B81B4AD054E520F9953522A5DF1BBC73FF6AD3FE59DFEF5DCE0BDA9719DFF018D8AD7551DB5356D7C14D298E9DC1DB8F91AD3A1DFE07425489F75AD86D2F386832E7FD94161768D624688D84DC757107D9DBF156E11114415A0A97A222C94B94888888888888888888888888888888A1DDA7BB176CF106F9722AD2ACB6D3DD8BB678837CB915695AB3B3CD02CF13BAAA7AF3691771D11111598A2AA56D9DF22E5B4E2AAFB652557C19454348EA8A8AF7C464646F208899A0D38B9DEB1F25AF23AB45D066A64C62DC9ABD3ADD89ED5252B5CE2D82B6305F4D52738E4D343C343A1D1C351A8B4A764BC9C6E4EE515BE9EA61CBEDD40B85C5DA7CA6BDCD1B916BDCC6E834EADEDF23AD4B977B35BF15BA6ABA5D35CA8661BB2D2D5C2D96278EE735C083F6A8E3ED373231A0AB7FDCAAD2817461C690617B8B631CA758CBA88DDD6B9D621A9AF639C2177C559FF8626B63256416B9FDFD5952C0776285A0EA1C7FC7E869CF7BDAAFADC7636C9CBA56BEAA6C154EC95EEDE2DA7ABA9863FB18C9340F50A49C1B80B0EE5EDABEDC3766A3B2D1EA1CE8E9220CDF769A6F3CF5B9DA7371257946B4D8F865AC69A9DABD721746620CCB22C7883B48392B534CBAC0A2EFD45BB5DF21C3DB3E63CAA9FD092D72520FAD369B7FD5205292A19EE8267BD25E26A6CB7B255367651CE2A6F12C4ED5A25088ED41D096EA5CE1C8EEEB6B8E4CA423163340E2A6D6D4E324A4623DC7294DE4E4FDF82A54B54B636CDE8B34F272DD4F3CE1F7CBB196EAE613F28B5A348653C4921EC389EB735FDCB2B54879179D177C8BC794D882DA3DF34CE1D0D75039DA32AA2412DD793869AB5DC88E696513B2FE910A8338CCA9FB06D4FA2E6C3DFF71D91DFAFC3A556C2A8573D367883322475EACD2454388434949C22AA0683788EA701C3B8F50791120E5BE6561FCD8C294B883E5736B2866EE69E12C126837A391BF35E35EAF582090413EA5466566A3D9F1845827B87FB4215C76859D256EC999799687C376547C883A8FFE6659D58832BB16E179DF15CBF5C20DC3A195B19223EC7B7569FBAFB87F2B3176289D915B7F5C26F3A95F18E21ED91DA347DA568A229A7AE531829DDC5B6A69CBF7553FD55C977B5F4976D9415E79BFA5413947B305AF0AD1CD558A63A6BD5CEA23319A72DDE829DA781DDD7D2769F3B869CBBCC679CDB3156E14F7C5E30BB65B959C6AF928FD29E9873D3E9B077F581D7AE85CAE12E871AE37B465FD867BB5E6A4414F1F063719267F2631BCDC7FE4E812B8D2B6EDA3E99DEB5D8CBB261D4771AB753E6A5768DCDB4D97E8CF684D869FF786D249CFBC1C9B299299BEAC6C69DBDBD7861F36350E639C4E31962CB9DE5B4305B59572991B4B4CD1AC1D5C74EB71EB279924F0D54C7B1A76F6F5E187CD8D59B6D173ACA8AE78A12D151B336459F2E9358CBC92CD86EC4DF3434A545DD355762B7CAAEEDADF9DC1FF56AFF092AD12ABBB6B7E777FD5ABFE4AAC2ED69585F9BFB4AD0F7FF0F0DCCFE4FF02355635E9B2C3F49784BC5E93CE62F32BD36587E92F0978BD279CC5744CFB089C0F4593ACFFE72F89BD42D1844459C16F354BD11164A5CA44444444444444444444444444444450F6D3A3FE8AB6F8837CB91568445AB7B3CD2CF13BAAA7AF36917701D11111596A2AA77D9DF69BC7B9717BB461EA2B9B6E361A8A88E9C5BAE6D334787380D623A87334D4E83B7753A9695A9EC3BCC693D646A88A2969B5AD8A2815CB7462C48926EF7134341539B82FD2222E3A9DAAABB74679E2CCA9B4D9AD3862AE3B6FC331CC27AE639A98C37746913B5D19A871F95A6F0EB41E2B38E491F348E924739F23C9739CE3A924F5925114B6CD68102A65549DEC88F75A25849A028350E0BF2888BACA16BD7E5966D629CABF8BB617BA494133B41347E54150D1F36461E0E1C4FAC6BA82F15AE396189EAB1AE5E61DBF57470C55971A18AA65653B488DAE734121A924E3CC94451DB55A0617532AB46E644791161971C22941AB92F50888A3CACF5E7B331054E14C1778BBD232292A68E9DD2C6D9812C2477841D3ED540B1A63BBDE3FBB3AE17CAE7D64C3511B3D18E26FD16347068FC79EA51159973A1B0F7B1B46214CBAD67EED4E3C5699782D79C20922A6848CC48CD9179F5603634EDEDEBC3F9B1A22975BDA3237F30AB1B99F88253C5E455BE55776D6FCEE0FF0AB57FC9445565DAD2BBF37F695A36FF0FE1B99FC9FE46AAC6BD36587E92F978BD279CC445744CFB89CF4593ACFF0E720F89BD42D1844459C16F35FFFD9");

                // Create Data packet
                auto data = make_shared<Data>(interest.getName());
                data->setFreshnessPeriod(10_s);
                data->setContent(make_span(reinterpret_cast<const uint8_t*>(content.data()), content.size()));

                // in order for the consumer application to be able to validate the packet, you need to setup
                // the following keys:
                // 1. Generate example trust anchor
                //
                //         ndnsec key-gen /example
                //         ndnsec cert-dump -i /example > example-trust-anchor.cert
                //
                // 2. Create a key for the producer and sign it with the example trust anchor
                //
                //         ndnsec key-gen /example/testApp
                //         ndnsec sign-req /example/testApp | ndnsec cert-gen -s /example -i example | ndnsec cert-install -

                // Sign Data packet with default identity
                m_keyChain.sign(*data);
                // m_keyChain.sign(*data, signingByIdentity(<identityName>));
                // m_keyChain.sign(*data, signingByKey(<keyName>));
                // m_keyChain.sign(*data, signingByCertificate(<certName>));
                // m_keyChain.sign(*data, signingWithSha256());

                // Return Data packet to the requester
                std::cout << "<< D: " << *data << std::endl;
                m_face.put(*data);
            }

            void
            onRegisterFailed(const Name& prefix, const std::string& reason)
            {
                std::cerr << "ERROR: Failed to register prefix '" << prefix
                          << "' with the local forwarder (" << reason << ")" << std::endl;
                m_face.shutdown();
            }

        private:
            Face m_face;
            KeyChain m_keyChain;
            ScopedRegisteredPrefixHandle m_certServeHandle;
        };

    } // namespace examples
} // namespace ndn

int
main(int argc, char** argv)
{
    try {
        ndn::examples::Producer producer;
        producer.run();
        return 0;
    }
    catch (const std::exception& e) {
        std::cerr << "ERROR: " << e.what() << std::endl;
        return 1;
    }
}